<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HederaGenesis - Fiat On/Off Ramp</title>
  <!-- <script src="https://checkout.flutterwave.com/v3.js"></script> -->
    <script src="assets/js/libs/v3.js"></script>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --success-color: #10b981;
      --error-color: #ef4444;
      --warning-color: #f59e0b;
      --glass-bg: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.15);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: radial-gradient(ellipse at top, #1e1b4b 0%, #0f0f23 50%, #000000 100%);
      color: #ffffff;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml,<svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><g fill="%23ffffff" fill-opacity="0.02"><circle cx="30" cy="30" r="1"/></g></svg>');
      pointer-events: none;
      z-index: -1;
    }
    
    .container {
      width: 100%;
      max-width: 500px;
    }
    
    .logo {
      text-align: center;
      font-size: 2rem;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 2rem;
    }
    
    /* Card styles */
    .card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      backdrop-filter: blur(20px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .card-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
    }

    /* Form styles */
    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      border-radius: 12px;
      border: 1px solid var(--glass-border);
      background: rgba(255, 255, 255, 0.05);
      color: white;
      font-size: 1rem;
    }

    .form-group input::placeholder {
      color: #9ca3af;
    }

    /* Button styles */
    .btn {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
      font-size: 1rem;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Status message */
    .status {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
      z-index: 10000;
    }
    
    .status.success {
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid var(--success-color);
      color: var(--success-color);
    }
    
    .status.error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid var(--error-color);
      color: var(--error-color);
    }
    
    .status.loading {
      background: rgba(245, 158, 11, 0.2);
      border: 1px solid var(--warning-color);
      color: var(--warning-color);
    }

    /* Toggle group */
    .toggle-group {
      display: flex;
      margin-bottom: 1.5rem;
    }

    .toggle-btn {
      flex: 1;
      text-align: center;
      padding: 0.8rem;
      border: 1px solid var(--glass-border);
      background: rgba(255, 255, 255, 0.05);
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .toggle-btn.active {
      background: var(--primary-gradient);
      font-weight: bold;
    }

    .coming-soon {
      text-align: center;
      padding: 2rem;
      color: #9ca3af;
      font-style: italic;
    }

    .wallet-info {
      background: rgba(255, 255, 255, 0.05);
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .wallet-address {
      font-family: monospace;
      word-break: break-all;
      color: #9ca3af;
    }
    
    .api-info {
      background: rgba(255, 255, 255, 0.05);
      padding: 0.5rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      text-align: center;
      font-size: 0.8rem;
      color: #9ca3af;
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="logo">🌌 HederaGenesis Ramp</div>
    
    <div class="api-info" id="apiInfo">
      Connecting to: <span id="apiUrl">Detecting...</span>
    </div>
    
    <div class="wallet-info" id="walletInfo">
      <div>Connected Wallet:</div>
      <div class="wallet-address" id="walletAddress">Loading...</div>
    </div>

    <div class="card">
      <h3 class="card-title">💳 Fiat On/Off Ramp</h3>
      <p style="text-align: center; margin-bottom: 1.5rem; color: #9ca3af;">
        Buy crypto with fiat currency using Flutterwave
      </p>

      <!-- Toggle Buy/Sell -->
      <div class="toggle-group">
        <div class="toggle-btn active" id="buyBtn">Buy Crypto</div>
        <div class="toggle-btn" id="sellBtn">Sell Crypto</div>
      </div>

      <!-- Buy Form -->
      <form id="buyForm">
        <div class="form-group">
          <label for="fiatAmount">Amount (Fiat)</label>
          <input type="number" id="fiatAmount" placeholder="Enter amount" required />
        </div>

        <div class="form-group">
          <label for="fiatCurrency">Currency</label>
          <select id="fiatCurrency">
            <option value="USD">USD - US Dollar</option>
            <option value="NGN" disabled>NGN - Nigerian Naira</option>
            <option value="EUR" disabled>EUR - Euro</option>
            <option value="GBP" disabled>GBP - British Pound</option>
          </select>
        </div>

        <div class="form-group">
          <label for="cryptoToken">Receive Token</label>
          <select id="cryptoToken">
            <option value="USDD">USDD - United States Dollar Decentralised </option>
            <option value="MTX" disabled>MTX - MyTokenX</option>
            <option value="SOMI" disabled>SOMI - Somnia</option>
          </select>
        </div>

        <div class="form-group">
          <label for="userEmail">Email Address</label>
          <input type="email" id="userEmail" placeholder="your@email.com" required />
        </div>

        <div class="form-group">
          <label for="userName">Full Name</label>
          <input type="text" id="userName" placeholder="Your full name" required />
        </div>

        <button type="submit" class="btn" id="checkoutBtn">
          <span id="checkoutText">Proceed to Payment</span>
        </button>
        <div id="rampStatus" class="status" style="display: none;"></div>
      </form>

      <!-- Sell Form (Coming Soon) -->
      <div id="sellForm" style="display: none;">
        <div class="coming-soon">
          <h3>Coming Soon</h3>
          <p>Sell crypto functionality will be available soon.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Network Configurations
    const NETWORK_CONFIGS = {
      mainnet: {
        chainId: 5031,
        name: 'Somnia Mainnet',
        symbol: 'SOMI',
        flutterwave: {
          publicKey: 'FLWPUBK-9535229707e778e50c2265f91e25f0bd-X' // Replace with live key
        }
      },
      testnet: {
        chainId: 50312,
        name: 'Somnia Testnet',
        symbol: 'STT',
        flutterwave: {
          publicKey: 'FLWPUBK_TEST-2e1916b73be8b0d2011af6d4366e00b2-X' // Replace with test key
        }
      }
    };

    // Determine API base URL based on hostname
    function getApiBaseUrl() {
      const isLocalhost = window.location.hostname === 'localhost' || 
                          window.location.hostname === '127.0.0.1' ||
                          window.location.hostname === '';
      
      return isLocalhost 
        ? 'http://localhost:4000/api/ramp' 
        : 'http://20.208.128.130:4000/api/ramp';
    }

    // Get the API base URL
    const API_BASE = getApiBaseUrl();
    const SEND_TOKENS_ENDPOINT = `${API_BASE}/send_tokens`;

    class SomniaRamp {
      constructor() {
        this.walletAddress = this.getWalletAddressFromUrl();
        this.config = NETWORK_CONFIGS.testnet; // Default to testnet for now - mainnet
        this.mode = 'buy';
        
        this.init();
      }

      getWalletAddressFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const address = urlParams.get('wallet_address');
        
        if (!address) {
          console.log('Wallet address parameter is required. Please add ?wallet_address=0x... to the URL');
          return null;
        }
        
        // Basic validation for Ethereum address format
        if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
            //  alert('Invalid wallet address format');
          console.log('Invalid wallet address format');
          return null;
        }
        
        return address;
      }

      init() {
        if (!this.walletAddress) return;
        
        this.displayApiInfo();
        this.displayWalletAddress();
        this.bindEvents();
      }

      displayApiInfo() {
        const apiUrlEl = document.getElementById('apiUrl');
        apiUrlEl.textContent = API_BASE;
        
        // Show if we're using local or remote API
        const isLocal = API_BASE.includes('localhost');
        document.getElementById('apiInfo').style.backgroundColor = isLocal 
          ? 'rgba(245, 158, 11, 0.1)' 
          : 'rgba(16, 185, 129, 0.1)';
      }

      displayWalletAddress() {
        const walletAddressEl = document.getElementById('walletAddress');
        walletAddressEl.textContent = this.walletAddress;
      }

      bindEvents() {
        const buyBtn = document.getElementById('buyBtn');
        const sellBtn = document.getElementById('sellBtn');
        const buyForm = document.getElementById('buyForm');
        const sellForm = document.getElementById('sellForm');

        buyBtn.addEventListener('click', () => {
          this.setMode('buy');
          buyBtn.classList.add('active');
          sellBtn.classList.remove('active');
          buyForm.style.display = 'block';
          sellForm.style.display = 'none';
        });

        sellBtn.addEventListener('click', () => {
          this.setMode('sell');
          sellBtn.classList.add('active');
          buyBtn.classList.remove('active');
          buyForm.style.display = 'none';
          sellForm.style.display = 'block';
        });

        buyForm.addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleFlutterwavePayment();
        });
      }

      setMode(mode) {
        this.mode = mode;
        document.getElementById('checkoutText').textContent = 
          mode === 'buy' ? 'Proceed to Payment' : 'Sell Crypto';
      }

      // async handleFlutterwavePayment() {
      //   const fiatAmount = document.getElementById('fiatAmount').value;
      //   const fiatCurrency = document.getElementById('fiatCurrency').value;
      //   const cryptoToken = document.getElementById('cryptoToken').value;
      //   const userEmail = document.getElementById('userEmail').value;
      //   const userName = document.getElementById('userName').value;
      //   const rampStatus = document.getElementById('rampStatus');

      //   if (!fiatAmount || !userEmail || !userName) {
      //     this.showStatus('❌ Please fill in all required fields', 'error', rampStatus);
      //     return;
      //   }

      //   const txRef = `somnia-${this.mode}-${Date.now()}`;
        
      //   const config = {
      //     public_key: this.config.flutterwave.publicKey,
      //     tx_ref: txRef,
      //     amount: parseFloat(fiatAmount),
      //     currency: fiatCurrency,
      //     customer: {
      //       email: userEmail,
      //       name: userName,
      //     },
      //     customizations: {
      //       title: `HederaGenesis - ${this.mode === 'buy' ? 'Buy' : 'Sell'} ${cryptoToken}`,
      //       description: `${this.mode === 'buy' ? 'Purchase' : 'Sell'} ${cryptoToken} tokens`,
      //       logo: 'https://your-logo-url.com/logo.png',
      //     },
      //     callback: (response) => {
      //       this.handlePaymentCallback(response, cryptoToken, fiatAmount, fiatCurrency, txRef);
      //     },
      //     onclose: () => {
      //       this.showStatus('❌ Payment cancelled', 'error', rampStatus);
      //     },
      //   };

      //   FlutterwaveCheckout(config);
      // }

      // async handlePaymentCallback(response, cryptoToken, fiatAmount, fiatCurrency, txRef) {
      //   const rampStatus = document.getElementById('rampStatus');
        
      //   if (response.status === 'successful') {
      //     this.showStatus('⏳ Payment successful! Processing token transfer...', 'loading', rampStatus);

      //     try {
      //       // Send payment details to backend for token processing
      //       const requestData = {
      //         transactionId: response.transaction_id || txRef,
      //         status: response.status,
      //         mode: this.mode,
      //         token: cryptoToken,
      //         amount: fiatAmount,
      //         currency: fiatCurrency,
      //         userEmail: document.getElementById('userEmail').value,
      //         userName: document.getElementById('userName').value,
      //         walletAddress: this.walletAddress
      //       };

      //       console.log('Sending request to:', SEND_TOKENS_ENDPOINT);
      //       console.log('Request data:', requestData);

      //       const backendResponse = await fetch(SEND_TOKENS_ENDPOINT, {
      //         method: 'POST',
      //         headers: {
      //           'Content-Type': 'application/json',
      //         },
      //         body: JSON.stringify(requestData)
      //       });

      //       const result = await backendResponse.json();

      //       if (backendResponse.ok && result.success) {
      //         if (this.mode === 'buy') {
      //           this.showStatus(
      //             `✅ Success! ${result.tokenAmount || cryptoToken} tokens sent to your wallet. Transaction: ${result.transactionHash || ''}`, 
      //             'success', 
      //             rampStatus
      //           );
      //         } else {
      //           this.showStatus(
      //             `✅ Sale completed! You received ${fiatAmount} ${fiatCurrency} in your account`, 
      //             'success', 
      //             rampStatus
      //           );
      //         }
      //       } else {
      //         this.showStatus(
      //           `❌ Payment successful but token processing failed: ${result.error || 'Unknown error'}. Contact support.`, 
      //           'error', 
      //           rampStatus
      //         );
      //         console.error('Backend error:', result.error);
      //       }
      //     } catch (error) {
      //       console.error('Token processing error:', error);
      //       this.showStatus(
      //         '❌ Payment successful but token processing failed. Contact support.', 
      //         'error', 
      //         rampStatus
      //       );
      //     }
      //   } else {
      //     this.showStatus('❌ Payment failed. Please try again.', 'error', rampStatus);
      //   }
      // }

      async handleFlutterwavePayment() {
    const fiatAmount = document.getElementById('fiatAmount').value;
    const fiatCurrency = document.getElementById('fiatCurrency').value;
    const cryptoToken = document.getElementById('cryptoToken').value;
    const userEmail = document.getElementById('userEmail').value;
    const userName = document.getElementById('userName').value;
    const rampStatus = document.getElementById('rampStatus');

    if (!fiatAmount || !userEmail || !userName) {
      this.showStatus('❌ Please fill in all required fields', 'error', rampStatus);
      return;
    }

    const txRef = `somnia-${this.mode}-${Date.now()}`;

    // Track payment status
    let paymentHandled = false;

    const config = {
      public_key: this.config.flutterwave.publicKey,
      tx_ref: txRef,
      amount: parseFloat(fiatAmount),
      currency: fiatCurrency,
      customer: {
        email: userEmail,
        name: userName,
      },
      customizations: {
        title: `HederaGenesis - ${this.mode === 'buy' ? 'Buy' : 'Sell'} ${cryptoToken}`,
        description: `${this.mode === 'buy' ? 'Purchase' : 'Sell'} ${cryptoToken} tokens`,
        logo: 'https://your-logo-url.com/logo.png',
      },
      callback: (response) => {
        paymentHandled = true; // ✅ mark as handled
        this.handlePaymentCallback(response, cryptoToken, fiatAmount, fiatCurrency, txRef);
      },
      onclose: () => {
        if (!paymentHandled) {
          // Only show this if no successful payment was processed
          this.showStatus('❌ Payment cancelled', 'error', rampStatus);
        }
      },
    };

    FlutterwaveCheckout(config);
  }

  async handlePaymentCallback(response, cryptoToken, fiatAmount, fiatCurrency, txRef) {
    const rampStatus = document.getElementById('rampStatus');

    if (response.status === 'successful') {
      this.showStatus('⏳ Payment successful! Processing token transfer...', 'loading', rampStatus);

      try {
        const requestData = {
          transactionId: response.transaction_id || txRef,
          status: response.status,
          mode: this.mode,
          token: cryptoToken,
          amount: fiatAmount,
          currency: fiatCurrency,
          userEmail: document.getElementById('userEmail').value,
          userName: document.getElementById('userName').value,
          walletAddress: this.walletAddress
        };

        const backendResponse = await fetch(SEND_TOKENS_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestData)
        });

        const result = await backendResponse.json();

        if (backendResponse.ok && result.success) {
          if (this.mode === 'buy') {
            this.showStatus(
              `✅ Success! ${result.tokenAmount} ${cryptoToken} sent to your wallet. Transaction: ${result.transactionHash}`,
              'success',
              rampStatus
            );
          } else {
            this.showStatus(
              `✅ Sale completed! You received ${fiatAmount} ${fiatCurrency} in your account`,
              'success',
              rampStatus
            );
          }
        } else {
          this.showStatus(
            `❌ Payment successful but token processing failed: ${result.error || 'Unknown error'}. Contact support.`,
            'error',
            rampStatus
          );
        }
      } catch (error) {
        console.error('Token processing error:', error);
        this.showStatus(
          '❌ Payment successful but token processing failed. Contact support.',
          'error',
          rampStatus
        );
      }
    } else {
      this.showStatus('❌ Payment failed. Please try again.', 'error', rampStatus);
    }
  }


      showStatus(message, type, element) {
        element.textContent = message;
        element.className = `status ${type}`;
        element.style.display = 'block';
        
        // Auto-hide success messages after 5 seconds - I changed to 15
        if (type === 'success') {
          setTimeout(() => {
            element.style.display = 'none';
          }, 15000);
        }
      }
    
    }

    // Initialize the ramp page
    document.addEventListener('DOMContentLoaded', function() {
      window.somniaRamp = new SomniaRamp();
    });
  </script>
</body>
</html>